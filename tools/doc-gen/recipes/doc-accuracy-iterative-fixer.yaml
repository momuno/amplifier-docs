name: "doc-accuracy-iterative-fixer"
description: "Iteratively check and fix documentation accuracy with up to 5 automatic attempts, escalating to human review if needed"
version: "1.0.0"
author: "Doc-Gen Tool"
tags: ["documentation", "quality", "iterative", "validation", "automatic-fixing"]

context:
  doc_path: ""              # e.g., "docs/api/overview.md"
  staged_file: ""           # e.g., "/path/.doc-gen/staging/docs/api/overview.md"
  outline_file: ""          # e.g., "/path/.doc-gen/amplifier-docs-cache/.../outline.json"

recursion:
  max_depth: 5
  max_total_steps: 100

stages:
  # =======================
  # ITERATION 1
  # =======================
  - name: "iteration-1"
    steps:
      - id: "check-1"
        agent: "foundation:explorer"
        prompt: |
          DOCUMENTATION COMPLETENESS CHECK - ITERATION 1
          
          Task: Check if material from source files listed in the outline is MISSING from the generated documentation.
          
          Files to analyze:
          - Staged markdown: {{staged_file}}
          - Outline JSON: {{outline_file}}
          
          CRITICAL FOCUS: For each section, check if any **material from the source files listed in the outline for that section** SHOULD be present but is NOT currently present in the generated markdown.
          
          Instructions:
          1. Read the staged markdown file ({{staged_file}})
          2. Read the outline JSON ({{outline_file}}) which contains:
             - _meta.document_instruction (overall document intent and style guide)
             - document.sections[] (array of sections with heading, prompt, sources[], reasoning)
          
          3. For EACH section in document.sections[]:
             a. Read the section heading and identify the corresponding section in {{staged_file}}
             b. Read the section's prompt field (describes what should be documented)
             c. Read ALL source files listed in section.sources[]
             d. For each source file:
                i. Read the actual content of the source file from the url
             e. Read the reasoning field for each source (explains WHY the source was included)
             e. **KEY CHECK**: Compare the actual content in the source files against what appears in the generated markdown section
             f. Flag any material from the source files that SHOULD be present (based on the section prompt, document intent, and reasoning) but is NOT present
          
          Evaluation Criteria (determine "should be present"):
          - Document intent (_meta.document_instruction): What is the overall purpose and style?
          - Section prompt: What did the outline specifically ask to be documented?
          - Source file content: What relevant material exists in the source files?
          - Reasoning field: Why was each source file included? What specific aspects were deemed relevant?
          
          Priority Classification:
          - HIGH: Missing functional code examples, critical API usage, core concepts, methods/functions mentioned in reasoning
          - MEDIUM: Missing key implementation details, important context, patterns/behaviors mentioned in reasoning
          - LOW: Minor details, polish issues, formatting inconsistencies
          
          Output format (respond with valid JSON):
          {
            "iteration": 1,
            "needs_fixing": true/false,
            "total_issues": <number>,
            "high_priority_count": <number>,
            "medium_priority_count": <number>,
            "low_priority_count": <number>,
            "issues": [
              {
                "priority": "HIGH|MEDIUM|LOW",
                "section": "## Section Heading",
                "description": "Specific material from source file that is missing",
                "sources": ["file paths from outline where this material exists"],
                "source_content_missing": "Brief excerpt or description of what's in the source but not in the doc",
                "recommendation": "What specific content should be added from the source files"
              }
            ],
            "summary": "Brief summary of missing source file material"
          }
          
          Important: Focus on HIGH and MEDIUM priority issues. LOW priority issues should be noted but will NOT be fixed automatically.
        output: "check_1"
        timeout: 1200
      
      - id: "fix-1"
        condition: "{{check_1.needs_fixing}} == 'true'"
        agent: "developer-expertise:modular-builder"
        prompt: |
          FIX DOCUMENTATION ISSUES - ITERATION 1
          
          Task: Fix HIGH and MEDIUM priority issues in the staged documentation.
          
          Context:
          - Staged file to update: {{staged_file}}
          - Issues found: {{check_1}}
          - Outline reference: {{outline_file}}
          - Outline storage: {{outline_storage}}
          
          Instructions:
          1. Read the current staged markdown file ({{staged_file}})
          2. For EACH issue in {{check_1.issues}} where priority is HIGH or MEDIUM:
             a. Identify the exact section in the markdown
             b. Read the source files mentioned in the issue
             c. Add the missing content to the appropriate location
             d. Maintain document structure, style, and formatting
             e. Ensure code examples are functional and complete
          3. Do NOT fix LOW priority issues
          4. Update the staged file ({{staged_file}}) in place using write_file
          
          Output format (respond with valid JSON):
          {
            "iteration": 1,
            "fixes_applied": <number>,
            "issues_fixed": [
              {
                "priority": "HIGH|MEDIUM",
                "section": "## Section Heading",
                "what_was_added": "Description of content added"
              }
            ],
            "file_updated": "{{staged_file}}",
            "summary": "Summary of all changes made"
          }
        output: "fix_1"
        timeout: 1800
      
      - id: "verify-1"
        agent: "recipes:result-validator"
        prompt: |
          VERIFY DOCUMENTATION QUALITY - ITERATION 1
          
          Task: Determine if the documentation is ready for publication or needs more work.
          
          Context:
          - Staged file: {{staged_file}}
          - Original issues: {{check_1}}
          - Fixes applied: {{fix_1}}
          
          Evaluation criteria:
          1. Are all HIGH priority issues resolved?
          2. Are all MEDIUM priority issues resolved?
          3. Is the document complete and accurate?
          4. Are functional code examples present where required?
          
          Respond with clear verdict using this EXACT format:
          
          STATUS: PASS
          (if all HIGH and MEDIUM issues are resolved)
          
          OR
          
          STATUS: CONTINUE
          (if HIGH or MEDIUM issues remain)
          
          Evidence:
          - List what was successfully fixed
          - List what issues remain (if any)
          - Provide specific reasons for the verdict
          
          Make your verdict clear and unambiguous.
        output: "verify_1"
        timeout: 600

  # =======================
  # ITERATION 2
  # =======================
  - name: "iteration-2"
    steps:
      - id: "should-continue-2"
        condition: "{{verify_1}} != 'PASS'"
        agent: "foundation:explorer"
        prompt: |
          DOCUMENTATION COMPLETENESS CHECK - ITERATION 2
          
          Previous iteration:
          - Check: {{check_1}}
          - Fixes: {{fix_1}}
          - Verification: {{verify_1}}
          
          Task: Re-check if material from source files listed in the outline is MISSING from the generated documentation.
          
          Files: {{staged_file}}, {{outline_file}}, {{outline_storage}}
          
          CRITICAL FOCUS: For each section, check if any **material from the source files listed in the outline for that section** SHOULD be present but is NOT currently present in the generated markdown.
          
          Focus on:
          1. Verifying if previous fixes were properly applied
          2. Identifying any remaining HIGH/MEDIUM priority issues
          3. Checking source file content against generated markdown sections
          4. Using the section prompt, document intent (_meta.document_instruction), and reasoning field to determine what SHOULD be present
          
          Use same output format as iteration 1 with "iteration": 2.
        output: "check_2"
        timeout: 1200
      
      - id: "fix-2"
        condition: "{{check_2.needs_fixing}} == 'true'"
        agent: "developer-expertise:modular-builder"
        prompt: |
          FIX DOCUMENTATION ISSUES - ITERATION 2
          
          Staged file: {{staged_file}}
          Remaining issues: {{check_2}}
          Previous fixes: {{fix_1}}
          
          Apply fixes for HIGH and MEDIUM priority issues only.
          Use same output format as iteration 1 with "iteration": 2.
        output: "fix_2"
        timeout: 1800
      
      - id: "verify-2"
        condition: "{{verify_1}} != 'PASS'"
        agent: "recipes:result-validator"
        prompt: |
          VERIFY DOCUMENTATION QUALITY - ITERATION 2
          
          Staged: {{staged_file}}
          Current check: {{check_2}}
          Fixes: {{fix_2}}
          
          Verdict: STATUS: PASS or STATUS: CONTINUE
          
          Provide evidence for verdict.
        output: "verify_2"
        timeout: 600

  # =======================
  # ITERATION 3
  # =======================
  - name: "iteration-3"
    steps:
      - id: "should-continue-3"
        condition: "{{verify_2}} != 'PASS'"
        agent: "foundation:explorer"
        prompt: |
          DOCUMENTATION COMPLETENESS CHECK - ITERATION 3
          
          Files: {{staged_file}}, {{outline_file}}, {{outline_storage}}
          
          CRITICAL FOCUS: For each section, check if any **material from the source files listed in the outline for that section** SHOULD be present but is NOT currently present in the generated markdown.
          
          Re-check for remaining HIGH/MEDIUM priority issues by:
          1. Reading each section's source files from the outline
          2. Comparing source file content against the generated markdown
          3. Using section prompt, document intent, and reasoning to determine what SHOULD be present
          4. Flagging missing source file material that is required
          
          Output with "iteration": 3.
        output: "check_3"
        timeout: 1200
      
      - id: "fix-3"
        condition: "{{check_3.needs_fixing}} == 'true'"
        agent: "developer-expertise:modular-builder"
        prompt: |
          FIX DOCUMENTATION ISSUES - ITERATION 3
          
          Staged: {{staged_file}}
          Issues: {{check_3}}
          
          Fix HIGH and MEDIUM priority only.
          Output with "iteration": 3.
        output: "fix_3"
        timeout: 1800
      
      - id: "verify-3"
        condition: "{{verify_2}} != 'PASS'"
        agent: "recipes:result-validator"
        prompt: |
          VERIFY DOCUMENTATION QUALITY - ITERATION 3
          
          Staged: {{staged_file}}
          Check: {{check_3}}
          Fixes: {{fix_3}}
          
          Verdict: STATUS: PASS or STATUS: CONTINUE
        output: "verify_3"
        timeout: 600

  # =======================
  # ITERATION 4
  # =======================
  - name: "iteration-4"
    steps:
      - id: "should-continue-4"
        condition: "{{verify_3}} != 'PASS'"
        agent: "foundation:explorer"
        prompt: |
          DOCUMENTATION COMPLETENESS CHECK - ITERATION 4
          
          Files: {{staged_file}}, {{outline_file}}, {{outline_storage}}
          
          CRITICAL FOCUS: For each section, check if any **material from the source files listed in the outline for that section** SHOULD be present but is NOT currently present in the generated markdown.
          
          Re-check for remaining issues by:
          1. Reading each section's source files from the outline
          2. Comparing source file content against the generated markdown
          3. Using section prompt, document intent, and reasoning to determine what SHOULD be present
          4. Flagging missing source file material that is required
          
          Output with "iteration": 4.
        output: "check_4"
        timeout: 1200
      
      - id: "fix-4"
        condition: "{{check_4.needs_fixing}} == 'true'"
        agent: "developer-expertise:modular-builder"
        prompt: |
          FIX DOCUMENTATION ISSUES - ITERATION 4
          
          Staged: {{staged_file}}
          Issues: {{check_4}}
          
          Fix HIGH and MEDIUM priority.
          Output with "iteration": 4.
        output: "fix_4"
        timeout: 1800
      
      - id: "verify-4"
        condition: "{{verify_3}} != 'PASS'"
        agent: "recipes:result-validator"
        prompt: |
          VERIFY DOCUMENTATION QUALITY - ITERATION 4
          
          Staged: {{staged_file}}
          Check: {{check_4}}
          Fixes: {{fix_4}}
          
          Verdict: STATUS: PASS or STATUS: CONTINUE
        output: "verify_4"
        timeout: 600

  # =======================
  # ITERATION 5 (Final Auto)
  # =======================
  - name: "iteration-5-final"
    steps:
      - id: "should-continue-5"
        condition: "{{verify_4}} != 'PASS'"
        agent: "foundation:explorer"
        prompt: |
          DOCUMENTATION COMPLETENESS CHECK - ITERATION 5 (FINAL AUTOMATIC ATTEMPT)
          
          Files: {{staged_file}}, {{outline_file}}, {{outline_storage}}
          
          CRITICAL FOCUS: For each section, check if any **material from the source files listed in the outline for that section** SHOULD be present but is NOT currently present in the generated markdown.
          
          This is the final automatic check. Be thorough:
          1. Read each section's source files from the outline
          2. Compare source file content against the generated markdown
          3. Use section prompt, document intent (_meta.document_instruction), and reasoning to determine what SHOULD be present
          4. Flag missing source file material that is required
          5. Provide detailed analysis since this is the last automatic attempt
          
          Output with "iteration": 5.
        output: "check_5"
        timeout: 1200
      
      - id: "fix-5"
        condition: "{{check_5.needs_fixing}} == 'true'"
        agent: "developer-expertise:modular-builder"
        prompt: |
          FIX DOCUMENTATION ISSUES - ITERATION 5 (FINAL AUTOMATIC ATTEMPT)
          
          Staged: {{staged_file}}
          Issues: {{check_5}}
          
          Final automatic fix attempt - be thorough.
          Fix HIGH and MEDIUM priority.
          Output with "iteration": 5.
        output: "fix_5"
        timeout: 1800
      
      - id: "verify-5"
        condition: "{{verify_4}} != 'PASS'"
        agent: "recipes:result-validator"
        prompt: |
          VERIFY DOCUMENTATION QUALITY - ITERATION 5 (FINAL)
          
          Staged: {{staged_file}}
          Check: {{check_5}}
          Fixes: {{fix_5}}
          
          Final verification. Verdict: STATUS: PASS or STATUS: CONTINUE
        output: "verify_5"
        timeout: 600

  # =======================
  # CLEANLINESS CHECK PHASE
  # =======================
  # This phase runs ONLY if completeness check passed (any verify_1-5 == PASS)
  # Purpose: Verify that material in markdown ONLY comes from source files
  # or is reasonable synthesis of source material.
  
  # =======================
  # CLEANLINESS ITERATION 1
  # =======================
  - name: "cleanliness-1"
    steps:
      - id: "cleanliness-check-1"
        condition: "{{verify_1}} == 'PASS' or {{verify_2}} == 'PASS' or {{verify_3}} == 'PASS' or {{verify_4}} == 'PASS' or {{verify_5}} == 'PASS'"
        agent: "foundation:explorer"
        prompt: |
          DOCUMENTATION CLEANLINESS CHECK - ITERATION 1
          
          Task: Check if there is material in the markdown that does NOT come from source files listed in the outline.
          
          Files to analyze:
          - Staged markdown: {{staged_file}}
          - Outline JSON: {{outline_file}}
          
          CRITICAL FOCUS: Identify content in the markdown that does NOT appear in any source file AND is NOT a reasonable synthesis of source material.
          
          Instructions:
          1. Read the entire staged markdown file ({{staged_file}})
          2. Read the outline JSON ({{outline_file}}) to get all referenced source files
          3. Read ALL source files listed in the outline (from all sections)
          4. For each paragraph/section in the markdown:
             a. Does this content appear in any source file?
             b. If not, is it a natural synthesis of material from multiple sources? (ACCEPTABLE)
             c. If not synthesis, is it unrelated content that shouldn't be there? (MUST REMOVE)
          
          ACCEPTABLE content (do NOT flag):
          - Direct quotes or paraphrases from source files
          - Natural synthesis combining information from multiple sources
          - Transitional text that connects source materials
          - Formatting and structure (headers, lists, etc.)
          - Examples that combine patterns from source files
          
          UNACCEPTABLE content (MUST flag):
          - Factual claims not present in any source file
          - Code examples not derived from source files
          - API descriptions without source file backing
          - Implementation details not found in sources
          - Features or behaviors not mentioned in sources
          
          Priority Classification:
          - HIGH: Factual content that definitively doesn't appear in any source and isn't synthesis
          - MEDIUM: Content with unclear relationship to sources (might be synthesis)
          - LOW: Minor polish issues, formatting discrepancies
          
          Output format (respond with valid JSON):
          {
            "iteration": 1,
            "needs_fixing": true/false,
            "total_issues": <number>,
            "high_priority_count": <number>,
            "medium_priority_count": <number>,
            "low_priority_count": <number>,
            "issues": [
              {
                "priority": "HIGH|MEDIUM|LOW",
                "section": "## Section Heading",
                "description": "Content that doesn't come from sources",
                "markdown_content": "Brief excerpt of the problematic content",
                "source_check": "Why this doesn't appear in any source file",
                "recommendation": "Remove this content or clarify if it's valid synthesis"
              }
            ],
            "summary": "Brief summary of cleanliness issues found"
          }
          
          Important: Focus on HIGH and MEDIUM priority issues. Be careful not to flag reasonable synthesis.
        output: "cleanliness_check_1"
        timeout: 1200
      
      - id: "cleanliness-fix-1"
        condition: "{{cleanliness_check_1.needs_fixing}} == 'true'"
        agent: "developer-expertise:modular-builder"
        prompt: |
          FIX DOCUMENTATION CLEANLINESS ISSUES - ITERATION 1
          
          Task: Remove or annotate content based on cleanliness analysis.
          
          Context:
          - Staged file to update: {{staged_file}}
          - Issues found: {{cleanliness_check_1}}
          
          Instructions:
          1. Read the current staged markdown file ({{staged_file}})
          2. For EACH issue in {{cleanliness_check_1.issues}} where priority is HIGH:
             a. Locate the exact content in the markdown
             b. REMOVE content that definitively doesn't belong
             c. For MEDIUM priority, use judgment:
                - If it's likely valid synthesis, KEEP with optional note
                - If it's questionable, REMOVE or add [TODO: verify] note
          3. Do NOT fix LOW priority issues
          4. Maintain document structure, flow, and formatting
          5. Update the staged file ({{staged_file}}) in place using write_file
          
          Output format (respond with valid JSON):
          {
            "iteration": 1,
            "fixes_applied": <number>,
            "issues_fixed": [
              {
                "priority": "HIGH|MEDIUM",
                "section": "## Section Heading",
                "what_was_removed": "Description of content removed",
                "reasoning": "Why this content was removed"
              }
            ],
            "file_updated": "{{staged_file}}",
            "summary": "Summary of all cleanliness fixes made"
          }
        output: "cleanliness_fix_1"
        timeout: 1800
      
      - id: "cleanliness-verify-1"
        condition: "{{verify_1}} == 'PASS' or {{verify_2}} == 'PASS' or {{verify_3}} == 'PASS' or {{verify_4}} == 'PASS' or {{verify_5}} == 'PASS'"
        agent: "recipes:result-validator"
        prompt: |
          VERIFY DOCUMENTATION CLEANLINESS - ITERATION 1
          
          Task: Determine if all content in the documentation comes from source files or is reasonable synthesis.
          
          Context:
          - Staged file: {{staged_file}}
          - Original issues: {{cleanliness_check_1}}
          - Fixes applied: {{cleanliness_fix_1}}
          
          Evaluation criteria:
          1. Are all HIGH priority cleanliness issues resolved?
          2. Are all MEDIUM priority cleanliness issues resolved?
          3. Does all content trace back to source files or represent valid synthesis?
          
          Respond with clear verdict using this EXACT format:
          
          STATUS: PASS
          (if all HIGH and MEDIUM cleanliness issues are resolved)
          
          OR
          
          STATUS: CONTINUE
          (if HIGH or MEDIUM cleanliness issues remain)
          
          Evidence:
          - List what was successfully fixed
          - List what issues remain (if any)
          - Provide specific reasons for the verdict
          
          Make your verdict clear and unambiguous.
        output: "cleanliness_verify_1"
        timeout: 600

  # =======================
  # CLEANLINESS ITERATION 2
  # =======================
  - name: "cleanliness-2"
    steps:
      - id: "cleanliness-check-2"
        condition: "{{cleanliness_verify_1}} != 'PASS'"
        agent: "foundation:explorer"
        prompt: |
          DOCUMENTATION CLEANLINESS CHECK - ITERATION 2
          
          Previous iteration:
          - Check: {{cleanliness_check_1}}
          - Fixes: {{cleanliness_fix_1}}
          - Verification: {{cleanliness_verify_1}}
          
          Task: Re-check if there is material in the markdown that does NOT come from source files.
          
          Files: {{staged_file}}, {{outline_file}}
          
          Focus on:
          1. Verifying if previous cleanliness fixes were properly applied
          2. Identifying any remaining HIGH/MEDIUM priority cleanliness issues
          3. Checking each content block against all source files
          4. Distinguishing between invalid content and reasonable synthesis
          
          Use same output format as iteration 1 with "iteration": 2.
        output: "cleanliness_check_2"
        timeout: 1200
      
      - id: "cleanliness-fix-2"
        condition: "{{cleanliness_check_2.needs_fixing}} == 'true'"
        agent: "developer-expertise:modular-builder"
        prompt: |
          FIX DOCUMENTATION CLEANLINESS ISSUES - ITERATION 2
          
          Staged file: {{staged_file}}
          Remaining issues: {{cleanliness_check_2}}
          Previous fixes: {{cleanliness_fix_1}}
          
          Remove HIGH and MEDIUM priority invalid content only.
          Use same output format as iteration 1 with "iteration": 2.
        output: "cleanliness_fix_2"
        timeout: 1800
      
      - id: "cleanliness-verify-2"
        condition: "{{cleanliness_verify_1}} != 'PASS'"
        agent: "recipes:result-validator"
        prompt: |
          VERIFY DOCUMENTATION CLEANLINESS - ITERATION 2
          
          Staged: {{staged_file}}
          Current check: {{cleanliness_check_2}}
          Fixes: {{cleanliness_fix_2}}
          
          Verdict: STATUS: PASS or STATUS: CONTINUE
          
          Provide evidence for verdict.
        output: "cleanliness_verify_2"
        timeout: 600

  # =======================
  # CLEANLINESS ITERATION 3
  # =======================
  - name: "cleanliness-3"
    steps:
      - id: "cleanliness-check-3"
        condition: "{{cleanliness_verify_2}} != 'PASS'"
        agent: "foundation:explorer"
        prompt: |
          DOCUMENTATION CLEANLINESS CHECK - ITERATION 3
          
          Files: {{staged_file}}, {{outline_file}}
          
          Re-check for remaining HIGH/MEDIUM priority cleanliness issues.
          Verify each content block traces back to source files or is valid synthesis.
          
          Output with "iteration": 3.
        output: "cleanliness_check_3"
        timeout: 1200
      
      - id: "cleanliness-fix-3"
        condition: "{{cleanliness_check_3.needs_fixing}} == 'true'"
        agent: "developer-expertise:modular-builder"
        prompt: |
          FIX DOCUMENTATION CLEANLINESS ISSUES - ITERATION 3
          
          Staged: {{staged_file}}
          Issues: {{cleanliness_check_3}}
          
          Remove HIGH and MEDIUM priority invalid content.
          Output with "iteration": 3.
        output: "cleanliness_fix_3"
        timeout: 1800
      
      - id: "cleanliness-verify-3"
        condition: "{{cleanliness_verify_2}} != 'PASS'"
        agent: "recipes:result-validator"
        prompt: |
          VERIFY DOCUMENTATION CLEANLINESS - ITERATION 3
          
          Staged: {{staged_file}}
          Check: {{cleanliness_check_3}}
          Fixes: {{cleanliness_fix_3}}
          
          Verdict: STATUS: PASS or STATUS: CONTINUE
        output: "cleanliness_verify_3"
        timeout: 600

  # =======================
  # CLEANLINESS ITERATION 4
  # =======================
  - name: "cleanliness-4"
    steps:
      - id: "cleanliness-check-4"
        condition: "{{cleanliness_verify_3}} != 'PASS'"
        agent: "foundation:explorer"
        prompt: |
          DOCUMENTATION CLEANLINESS CHECK - ITERATION 4
          
          Files: {{staged_file}}, {{outline_file}}
          
          Re-check for remaining cleanliness issues.
          Ensure all content comes from sources or is valid synthesis.
          
          Output with "iteration": 4.
        output: "cleanliness_check_4"
        timeout: 1200
      
      - id: "cleanliness-fix-4"
        condition: "{{cleanliness_check_4.needs_fixing}} == 'true'"
        agent: "developer-expertise:modular-builder"
        prompt: |
          FIX DOCUMENTATION CLEANLINESS ISSUES - ITERATION 4
          
          Staged: {{staged_file}}
          Issues: {{cleanliness_check_4}}
          
          Remove HIGH and MEDIUM priority invalid content.
          Output with "iteration": 4.
        output: "cleanliness_fix_4"
        timeout: 1800
      
      - id: "cleanliness-verify-4"
        condition: "{{cleanliness_verify_3}} != 'PASS'"
        agent: "recipes:result-validator"
        prompt: |
          VERIFY DOCUMENTATION CLEANLINESS - ITERATION 4
          
          Staged: {{staged_file}}
          Check: {{cleanliness_check_4}}
          Fixes: {{cleanliness_fix_4}}
          
          Verdict: STATUS: PASS or STATUS: CONTINUE
        output: "cleanliness_verify_4"
        timeout: 600

  # =======================
  # CLEANLINESS ITERATION 5 (Final Auto)
  # =======================
  - name: "cleanliness-5-final"
    steps:
      - id: "cleanliness-check-5"
        condition: "{{cleanliness_verify_4}} != 'PASS'"
        agent: "foundation:explorer"
        prompt: |
          DOCUMENTATION CLEANLINESS CHECK - ITERATION 5 (FINAL AUTOMATIC ATTEMPT)
          
          Files: {{staged_file}}, {{outline_file}}
          
          This is the final automatic cleanliness check. Be thorough:
          1. Read all source files from outline
          2. Check every content block in markdown
          3. Identify any content that doesn't trace to sources
          4. Distinguish invalid content from reasonable synthesis
          5. Provide detailed analysis since this is the last automatic attempt
          
          Output with "iteration": 5.
        output: "cleanliness_check_5"
        timeout: 1200
      
      - id: "cleanliness-fix-5"
        condition: "{{cleanliness_check_5.needs_fixing}} == 'true'"
        agent: "developer-expertise:modular-builder"
        prompt: |
          FIX DOCUMENTATION CLEANLINESS ISSUES - ITERATION 5 (FINAL AUTOMATIC ATTEMPT)
          
          Staged: {{staged_file}}
          Issues: {{cleanliness_check_5}}
          
          Final automatic fix attempt - be thorough.
          Remove HIGH and MEDIUM priority invalid content.
          Output with "iteration": 5.
        output: "cleanliness_fix_5"
        timeout: 1800
      
      - id: "cleanliness-verify-5"
        condition: "{{cleanliness_verify_4}} != 'PASS'"
        agent: "recipes:result-validator"
        prompt: |
          VERIFY DOCUMENTATION CLEANLINESS - ITERATION 5 (FINAL)
          
          Staged: {{staged_file}}
          Check: {{cleanliness_check_5}}
          Fixes: {{cleanliness_fix_5}}
          
          Final verification. Verdict: STATUS: PASS or STATUS: CONTINUE
        output: "cleanliness_verify_5"
        timeout: 600

  # =======================
  # HUMAN INTERVENTION
  # =======================
  - name: "human-review-required"
    steps:
      - id: "escalation-analysis"
        condition: "{{verify_5}} != 'PASS' or {{cleanliness_verify_5}} != 'PASS'"
        agent: "developer-expertise:zen-architect"
        mode: "ANALYZE"
        prompt: |
          ESCALATION ANALYSIS - HUMAN REVIEW REQUIRED
          
          Documentation: {{doc_path}}
          Staged file: {{staged_file}}
          Outline: {{outline_file}}
          
          The document has gone through automatic fix iterations but still has unresolved issues.
          
          ═══════════════════════════════════════════════════════════
          COMPLETENESS CHECK HISTORY (Iterations 1-5)
          Purpose: Verify material from source files IS present
          ═══════════════════════════════════════════════════════════
          
          Iteration 1:
          - Issues found: {{check_1}}
          - Fixes applied: {{fix_1}}
          - Verification: {{verify_1}}
          
          Iteration 2:
          - Issues found: {{check_2}}
          - Fixes applied: {{fix_2}}
          - Verification: {{verify_2}}
          
          Iteration 3:
          - Issues found: {{check_3}}
          - Fixes applied: {{fix_3}}
          - Verification: {{verify_3}}
          
          Iteration 4:
          - Issues found: {{check_4}}
          - Fixes applied: {{fix_4}}
          - Verification: {{verify_4}}
          
          Iteration 5 (Final):
          - Issues found: {{check_5}}
          - Fixes applied: {{fix_5}}
          - Verification: {{verify_5}}
          
          ═══════════════════════════════════════════════════════════
          CLEANLINESS CHECK HISTORY (Iterations 1-5)
          Purpose: Verify material in markdown ONLY comes from sources
          ═══════════════════════════════════════════════════════════
          
          Iteration 1:
          - Issues found: {{cleanliness_check_1}}
          - Fixes applied: {{cleanliness_fix_1}}
          - Verification: {{cleanliness_verify_1}}
          
          Iteration 2:
          - Issues found: {{cleanliness_check_2}}
          - Fixes applied: {{cleanliness_fix_2}}
          - Verification: {{cleanliness_verify_2}}
          
          Iteration 3:
          - Issues found: {{cleanliness_check_3}}
          - Fixes applied: {{cleanliness_fix_3}}
          - Verification: {{cleanliness_verify_3}}
          
          Iteration 4:
          - Issues found: {{cleanliness_check_4}}
          - Fixes applied: {{cleanliness_fix_4}}
          - Verification: {{cleanliness_verify_4}}
          
          Iteration 5 (Final):
          - Issues found: {{cleanliness_check_5}}
          - Fixes applied: {{cleanliness_fix_5}}
          - Verification: {{cleanliness_verify_5}}
          
          ═══════════════════════════════════════════════════════════
          ANALYSIS REQUIRED
          ═══════════════════════════════════════════════════════════
          
          1. What specific issues remain unresolved after all iterations?
          2. Which phase failed: completeness, cleanliness, or both?
          3. Why couldn't these issues be automatically fixed?
          4. What patterns do you see in the persistent issues?
          5. What manual intervention is needed?
          6. Is the document acceptable as-is with known limitations, or does it require manual fixes?
          
          Provide:
          - Clear summary of unresolved issues by phase (completeness vs cleanliness)
          - Root cause analysis of why auto-fix failed
          - Specific recommendations for manual intervention
          - Assessment of whether document is "good enough" vs "needs manual work"
          
          This analysis will be presented to a human for review and decision.
        output: "escalation"
        timeout: 900
    
    approval:
      required: true
      prompt: |
        ═══════════════════════════════════════════════════════════
        DOCUMENTATION QUALITY GATE - HUMAN REVIEW REQUIRED
        ═══════════════════════════════════════════════════════════
        
        Document: {{doc_path}}
        Staged Location: {{staged_file}}
        
        STATUS: After 5 automatic fix iterations, this document still has unresolved issues.
        
        ESCALATION ANALYSIS:
        {{escalation}}
        
        ───────────────────────────────────────────────────────────
        
        DECISION OPTIONS:
        
        1. APPROVE: Accept the document as-is
           - Choose this if the remaining issues are acceptable
           - Document will proceed with known limitations
           - You take responsibility for the current quality level
        
        2. DENY: Require manual intervention
           - Choose this if issues must be fixed before proceeding
           - Recipe will stop here
           - You will need to manually fix issues and re-run
        
        ───────────────────────────────────────────────────────────
        
        INSTRUCTIONS:
        1. Review the staged file: {{staged_file}}
        2. Review the escalation analysis above
        3. Decide: Accept (approve) or Require fixes (deny)
        
        To approve: amplifier run "approve recipe session <session-id> stage human-review-required"
        To deny: amplifier run "deny recipe session <session-id> stage human-review-required"
        
        ═══════════════════════════════════════════════════════════
      timeout: 0
      default: "deny"

# ============================================================================
# USAGE INSTRUCTIONS
# ============================================================================
#
# Execute this recipe:
#   amplifier run "execute doc-accuracy-iterative-fixer.yaml with 
#     doc_path='docs/api/overview.md' 
#     staged_file='/path/.doc-gen/staging/docs/api/overview.md'
#     outline_file='/path/.doc-gen/amplifier-docs-cache/.../outline.json'
#     outline_storage='/path/.doc-gen/amplifier-docs-cache'"
#
# The recipe has TWO validation phases:
#
# PHASE 1: COMPLETENESS CHECK (Iterations 1-5)
# - Verifies that material from source files IS present in the markdown
# - Automatically fixes HIGH and MEDIUM priority missing content
# - Early exit if any iteration passes
#
# PHASE 2: CLEANLINESS CHECK (Iterations 1-5)
# - Runs ONLY if completeness check passes
# - Verifies that material in markdown ONLY comes from source files
# - Removes content that doesn't trace to sources (or isn't valid synthesis)
# - Automatically fixes HIGH and MEDIUM priority invalid content
# - Early exit if any iteration passes
#
# PHASE 3: HUMAN REVIEW (if needed)
# - Triggered if EITHER phase fails all 5 iterations
# - Provides history from both completeness and cleanliness checks
# - Requires explicit approval or denial to continue
#
# Expected flow:
#   Completeness (1-5 iterations) → Cleanliness (1-5 iterations) → Human Review (if needed)
#
# Early exit: If document passes verification at any iteration within either phase,
#            subsequent iterations in that phase are automatically skipped.
#
# Iteration limits: Maximum 5 automatic attempts per phase to prevent infinite loops.
#
# Human review: If recipe reaches approval gate, you must explicitly approve or deny:
#              amplifier run "approve recipe session <session-id> stage human-review-required"
#              amplifier run "deny recipe session <session-id> stage human-review-required"
